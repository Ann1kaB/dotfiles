#!/bin/bash

STATUS=$(cat /sys/class/power_supply/BAT1/status)
CURRENT_TDP_FILE="/tmp/_set_tdp_current"
ryzenadj_command=$(ryzenadj --info | awk '/ stapm-limit/{print $5}'| cut -d'.' -f1)

set_ryzenadj_tdp() {
	ryzenadj --stapm-limit=${_stapm}000 --fast-limit=${_fast}000 --slow-limit=${_slow}000
	xsetroot -name "Setting TDP to ${_stapm}W$_addition"
}

case $ryzenadj_command in
	30) _stapm=25 _fast=25 _slow=25 && set_ryzenadj_tdp;;
	25) _stapm=20 _fast=20 _slow=20 && set_ryzenadj_tdp;;
	20) _stapm=15 _fast=15 _slow=15 && set_ryzenadj_tdp;;
	15) _stapm=12 _fast=12 _slow=12 _addition="(Battery Default)" && set_ryzenadj_tdp;;
	12) [ "$STATUS" != "Discharging" ] && _stapm=45 _fast=62 _slow=54 _addition="(Default)" || \
	_stapm=30 _fast=30 _slow=30 && set_ryzenadj_tdp;;
	*) _stapm=30 _fast=30 _slow=30 && set_ryzenadj_tdp;;
esac

echo "${_stapm}" > $CURRENT_TDP_FILE
